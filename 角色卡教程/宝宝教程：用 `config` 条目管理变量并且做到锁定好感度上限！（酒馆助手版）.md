# 宝宝教程：用 `config` 条目管理变量并且做到锁定好感度上限！（酒馆助手版）

你好呀！还在为 AI 不听话，偷偷把好感度加过 200 而烦恼吗？尤其是在那个重要的【特殊事件】完成之前！别担心，既然你有“酒馆助手”这个给力扩展，我们就能用一种更稳妥、更“霸道”的方式来定规矩，而且完全不用碰复杂的脚本！

**咱们的目标：** 在【特殊事件】没完成（也就是变量状态不是 2）的时候，无论 AI 怎么想，【络络好感度】变量的值**绝对不能超过 199**！

## 核心魔法：抢先定义 + 全局通知

我们的策略是这样的：

1. **第一个发言：** 首先，我们在提示词模板中勾选 `[GENERATE]` 选项从而启用功能。然后，我们设置一个专门的世界书条目，它的名字应该以 `[GENERATE:BEFORE]` 开头，**使用蓝灯并且关闭掉**，例如 `[GENERATE:BEFORE]config`
2. **“公告管理员”读取变量**：在这个“第一个发言”的条目里，我们先 `let config = {};` 创建一个空对象，然后用 `_.set(config, '变量名', getvar('变量.变量名'))` 的形式读取每个变量, 此处我们要读取络络好感度和特殊事件，则是 `_.set(config, '络络.好感度', getvar('变量.络络.好感度'))` 和 `_.set(config, '世界.特殊事件状态', getvar('变量.世界.特殊事件状态'))`
3. **当场检查，立刻修正：** 然后, 我们对 `config` 里的内容进行检查, 来调整一些不对的值. 例如，我们先用 `config.络络.好感度` 看看现在的好感度是多少。如果发现它超过了 199，但 ``config.世界.特殊事件状态`` 还不是 2，我们就**立刻行动**，使用下面会给出的 `变量更新({'变量.络络.好感度': 199})`，**马上**把这次处理中要用的好感度值强行改成 199。**（关键！这能让这轮后面跑的其他世界书条目读到的是修正后的值）**
4. **发布“官方公告”：** 我们把制作好的整个“全局公告板”`config`通过`define`函数发布出去
5. **统一看公告：** 让所有其他需要知道好感度的世界书条目，都别自己去 `getvar` 了，改成直接看 `config` 这个“公告板”上的 `config.好感度` 就行

**这样操作的好处是：**

* 在 AI 思考和生成回复**之前**，我们就已经把好感度的“天花板”给焊死了。
* 所有世界书条目读取的都是同一个来源 (`config`)，保证了数据的一致性，不会出现有的条目用旧值有的用新值的混乱情况。

**你需要确保：**

* 你添加了[这个酒馆助手脚本](https://sillytavern-stage-girls-dog.readthedocs.io/tool_and_experience/variable_in_lorebook_without_qr/#id13)
* 你理解 `setvar` 在你的环境里，是真的能**立刻影响**本轮后续 `getvar` 读取到的值

**开始操作！**

## 第一步：创建“Config”核心条目 (`[GENERATE:BEFORE]config`)

创建一个新的世界书条目，你可以这样写：

```ejs
<%_
let config = {};

_.set(config, '世界.特殊事件状态', Number(getvar('变量.世界.特殊事件状态') || 0));
_.set(config, '络络.好感度', Number(getvar('变量.络络.好感度') || 0));
_%>

<%_
// 准备给 ai 看的修正提示
let 修正提示 = '';

async function 更新变量(data) {
  await SillyTavern.eventSource.emit('在最新楼层更新变量', data);
  await Promise.all(Object.entries(data).map(([key, value]) => setvar(key, value)));
}

if (config.世界.特殊事件状态 !== 1 && config.络络.好感度 > 199) {
  // 条件不满足, 则络络好感度限制最多为 199
  config.络络.好感度 = 199;

  // 调整完变量后, 还要用 `更新变量` 把更新情况以 `@变量=值@` 的形式记录到消息楼层中
  await 更新变量('变量.络络.好感度', config.络络.好感度);

  修正提示 = `<!-- 系统提示：检测到好感度在特殊事件完成前超过上限，已强制修正为 ${config.络络.好感度} -->`;
}
_%>

<%_ define('config', config); _%>
<%= 修正提示 _%>
```

## 第二步：修改其他所有用到“好感度”的条目

现在，去检查你其他的世界书文件。把所有 `getvar('变量.络络.好感度')` 的地方，都改成 `config.好感度`。

**例子：**

* **改之前：**

    ```yaml
    ---
    某个旧条目:
    <%_
    const affection = parseInt(getvar('变量.络络.好感度') || 0);
    if (affection > 100) { /* ... */ }
    _%>
    ---
    ```

* **改之后：**

    ```yaml
    ---
    某个新条目:
      描述: 基于全局config进行判断。
    <%_
    // 直接使用 config 对象里的值
    let message = '';
    if (config.络络.好感度 > 100 && config.络络.好感度 <= 199) {
       message = `<!-- 好感度 (${config.络络.好感度}) 状态正常 -->`;
    } else if (config.络络.好感度 > 199) {
       // 理论上不该发生
       message = `<!-- 警告: 好感度 (${config.络络.好感度}) 仍超限! -->`;
    }
    _%>
    <%= message %>
    ---
    ```

## 第三步：初始化【特殊事件状态】

别忘了，你的 `变量.世界.特殊事件状态` 需要在游戏刚开始时是 `0`。可以在第一条消息里带上 `@变量.世界.特殊事件状态=0@`。

**总结一下怎么玩：**

1. 确保 `[GENERATE:BEFORE]config` 条目优先执行。
2. 它会检查好感度，如果超限就更改 `config` 里的值, 再用 `更新变量` 记录下这个更改
3. 然后把正确的好感度（和其他变量）放进 `config` 并用 `define` 广播
4. 其他所有条目都乖乖地去看 `config`
5. 这样，发给 AI 的提示词里，所有关于好感度的信息都是一致且正确的啦！

这个方法巧妙地利用了酒馆助手的功能，实现了在 EJS 层面更可靠的控制。快去试试看吧！记得测试哦！
